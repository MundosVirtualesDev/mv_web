---
import PageLayout from "../../layouts/PageLayout.astro";
import Container from "../../components/ui/Container.astro";
import Chip from "../../components/ui/Chip.astro";
import Button from "../../components/ui/Button.astro";
import ProjectCard from "../../components/cards/ProjectCard.astro";

import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((p) => ({ params: { slug: p.id } }));
}

const { slug } = Astro.params;
const projects = await getCollection("projects");
const project = projects.find((p) => p.id === slug);
if (!project) throw new Error("Proyecto no encontrado");

const tone = project.data.area === "automatizacion" ? "yellow" : "blue";

// relacionados por tags y área
const tags = new Set((project.data.tags ?? []).map(t=>t.toLowerCase()));
const related = projects
  .filter((p) => p.id !== project.id)
  .map((p) => {
    const pt = new Set((p.data.tags ?? []).map(t=>t.toLowerCase()));
    let inter = 0;
    tags.forEach((t)=>{ if(pt.has(t)) inter += 1; });
    const sameArea = p.data.area === project.data.area ? 1 : 0;
    return { p, score: inter + sameArea };
  })
  .sort((a,b)=> b.score - a.score)
  .slice(0,3)
  .map(x=>x.p);
---
<PageLayout title={`${project.data.title} | Proyectos | Mundos Virtuales`} description={project.data.excerpt} active="projects">
  <section class="page-hero">
    <Container>
      <p class="small">Proyecto</p>
      <h1 class="h1">{project.data.title}</h1>
      <p class="p">{project.data.excerpt}</p>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
        <Chip tone={tone}>{project.data.area === "automatizacion" ? "Automatización" : "Gestión del Efectivo"}</Chip>
        {(project.data.tags ?? []).slice(0, 6).map((t) => <Chip>{t}</Chip>)}
      </div>

      <div style="display:flex; gap:12px; margin-top:16px; flex-wrap:wrap;">
        <Button href="/contacto" variant="primary" tone={tone}>Quiero algo similar</Button>
        <Button href="/proyectos" variant="secondary">Volver a proyectos</Button>
      </div>
    </Container>
  </section>

  <section class="section compact">
    <Container>
      <article class="card" style="overflow:hidden;">
        <img src={project.data.coverImage.src} alt={project.data.title} />
      </article>
    </Container>
  </section>

  <section class="section compact">
    <Container>
      <article class="card" style="padding:18px;">
        <h2 class="h2">Detalle</h2>
        <div class="p" style="color: rgba(255,255,255,.84);">
          <project.Content />
        </div>
      </article>
    </Container>
  </section>

  <section class="section">
    <Container>
      <h2 class="h2">Proyectos relacionados</h2>
      <div class="grid g3" style="margin-top:16px;">
        {related.map((p) => <ProjectCard project={p} />)}
      </div>
    </Container>

    <style>
      .g3{ grid-template-columns:repeat(3,1fr); }
      @media (max-width: 980px){
        .g3{ grid-template-columns: 1fr; }
      }
    </style>
  </section>
</PageLayout>
