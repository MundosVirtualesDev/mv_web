---
import PageLayout from "../../layouts/PageLayout.astro";
import Container from "../../components/ui/Container.astro";
import ProjectCard from "../../components/cards/ProjectCard.astro";
import Chip from "../../components/ui/Chip.astro";
import Button from "../../components/ui/Button.astro";

import { getCollection } from "astro:content";

const all = await getCollection("projects");

const url = new URL(Astro.request.url);
const q = (url.searchParams.get("q") ?? "").toLowerCase().trim();
const area = url.searchParams.get("area"); // automatizacion | efectivo | null
const tagsParam = url.searchParams.get("tags") ?? "";
const tags = tagsParam.split(",").map(t => t.trim().toLowerCase()).filter(Boolean);

const filtered = all
  .filter((p) => (area ? p.data.area === area : true))
  .filter((p) => (q ? (p.data.title + " " + p.data.excerpt).toLowerCase().includes(q) : true))
  .filter((p) => (tags.length ? tags.every(t => (p.data.tags ?? []).map(x=>x.toLowerCase()).includes(t)) : true))
  .sort((a, b) => (b.data.date ?? "0000-00-00").localeCompare(a.data.date ?? "0000-00-00"));

const tagsUniverse = Array.from(new Set(all.flatMap(p => p.data.tags ?? []).map(t => t.toLowerCase()))).sort();
---
<PageLayout title="Proyectos | Mundos Virtuales" description="Casos y proyectos realizados." active="projects">
  <section class="page-hero">
    <Container>
      <h1 class="h1">Proyectos</h1>
      <p class="p">Casos de automatización industrial y gestión del efectivo.</p>

      <form class="filters" method="get" action="/proyectos">
        <label class="f">
          <span class="small">Buscar</span>
          <input name="q" value={q} placeholder="Buscar proyecto…" />
        </label>

        <label class="f">
          <span class="small">Área</span>
          <select name="area">
            <option value="">Todas</option>
            <option value="automatizacion" selected={area==="automatizacion"}>Automatización</option>
            <option value="efectivo" selected={area==="efectivo"}>Gestión del Efectivo</option>
          </select>
        </label>

        <label class="f wide">
          <span class="small">Tags (separados por coma)</span>
          <input name="tags" value={tagsParam} placeholder="robotica, plc, seguridad" />
        </label>

        <div class="f actions">
          <Button type="submit" variant="secondary">Filtrar</Button>
          <Button href="/proyectos" variant="ghost">Limpiar</Button>
        </div>
      </form>

      <div style="margin-top: 14px;">
        <div class="small">Tags sugeridos:</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px;">
          {tagsUniverse.slice(0, 10).map((t) => <Chip>{t}</Chip>)}
        </div>
      </div>
    </Container>
  </section>

  <section class="section">
    <Container>
      <div class="grid pg">
        {filtered.map((p) => <ProjectCard project={p} />)}
      </div>

      <div style="margin-top: 18px;">
        <div class="card" style="padding:18px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
          <div>
            <h3 class="h3" style="margin:0 0 6px;">¿Quieres un caso similar?</h3>
            <p class="p">Conversemos y armemos una solución a tu medida.</p>
          </div>
          <Button href="/contacto" variant="primary" tone="yellow">Hablemos</Button>
        </div>
      </div>
    </Container>
  </section>

  <style>
    .filters{
      margin-top: 18px;
      display:grid;
      grid-template-columns: 1fr 220px 1fr auto;
      gap: 12px;
    }
    .f{ display:flex; flex-direction:column; gap: 6px; }
    .wide{ grid-column: span 2; }
    input, select{
      border-radius: 14px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.90);
      font-family: var(--font-sans);
    }
    .actions{ flex-direction: row; align-items: end; gap: 10px; }
    .pg{ grid-template-columns: repeat(3, 1fr); gap: 18px; }
    @media (max-width: 980px){
      .filters{ grid-template-columns: 1fr; }
      .wide{ grid-column: auto; }
      .actions{ align-items: center; }
      .pg{ grid-template-columns: 1fr; }
    }
  </style>
</PageLayout>
